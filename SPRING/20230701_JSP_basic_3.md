# JSP 필수 이해 요소

1. JSP 처리 과정
JSP를 실행한다는 말은 곧 JSP 페이지를 컴파일한 결과인 서블릿 클래스를 실행한다는 의미가 됩니다.
정확하게 표현하기 위해서는 'JSP 페이지를 컴파일 한 서블릿'이라는 말을 사용해야겠지만, 글이 길어집니다.
그래서, 우리는 간소화하여 "JSP를 실행합니다." 또는 "JSP 페이지를 실행합니다."라는 표현을 사용할 것입니다.

["그림_3) JSP 처리 과정.pdf" 참고]
* WAS는 JSP 페이지에 대한 요청이 들어오면 다음과 같은 처리를 합니다.
1) JSP에 해당하는 서블릿이 존재하지 않을 경우（과정 1.1）
   - JSP 페이지로부터 자바 코드를 생성합니다. （과정 1.2）
   - 자바 코드를 컴파일해서 서블릿 클래스를 생성합니다. （과정 1.3）
   - 서블릿에 클라이언트 요청을 전달합니다. （과정 2.1）
   - 서블릿이 요청을 처리한 결과를 응답으로 생성합니다.（과정 2.2）
   - 응답을 웹 브라우저에 전송합니다. （과정 3）

2) JSP에 해당하는 서블릿이 존재하는 경우 （즉，이미 과정 1.1 ~ 1.3을 거친 경우）
   - 서블릿에 클라이언트 요청을 전달합니다. （과정 2.1）
   - 서블릿이 요청을 처리한 결과를 응답으로 생성합니다. （과정 2.2）
   - 응답을 웹 브라우저에 전송합니다. （과정 3）

즉, JSP 페이지를 요청할 때에는 JSP를 직접 실행하는 것이 아니라,
JSP를 자바 소스 코드로 변환한 뒤 컴파일해서 생성한 서블릿을 실행하는 것입니다.
여기서 JSP 페이지를 자바 코드로 변경하는 단계를 "변환（translation） 단계"（과정 1.2）라고 하며,
자바 코드를 서블릿 클래스로 변경하는 단계를 "컴파일（compile） 단계''（과정 1.3）라고 합니다.
톰켓은 작업폴더(예시 : work 폴더)에 JSP를 변환한 자바 소스 코드와 서블릿 클래스를 생성합니다.

2. 출력 버퍼와 응답
JSP 페이지는 응답 결과를 곧바로 웹 브라우저에 전송하지 않습니다.
대신 출력 버퍼(buffer)라고 불리는 곳에 임시로 응답 결과를 저장했다가
한 번에 웹 브라우저에 전송 합니다.

버퍼를 사용하면 성능이 향상되는데, 그 이유는 작은 단위로 데이터를 전송하는 것이 아니라
한 번에 큰 단위로 데이터를 전송하는 것이 가능하기 때문입니다. 네트워크를 비롯한
모든 데이터 교환에서는 작은 단위를 여러 차례 보내는 것보다,
큰 단위로 한 번에 묶어서 보내는 것이 더 높은 성능을 발휘하게 됩니다.
두 번째 장점은 버퍼를 사용함으로써 <jsp：forward> 기능과 에러 페이지 처리 기능이
가능하다는 점입니다. JSP 페이지가 생성한 결과를 일단 버퍼에 저장하기 때문에,
버퍼에 보관된 데이터가 일정 크기가 될 때까지 웹 브라우저에 전송되는 데이터는 없습니다.
따라서, JSP 페이지가 생성한 내용이 있다 하더라도 버퍼에 저장된 데이터가 웹 브라우저로
전송되기 전까지는 버퍼에 보관된 데이터를 지우고 새로운 내용을 전송할 수 있습니다.
예를들어, JSP 실행 과정에서 에러가 발생하면, 지금까지 생성한 내용을 버퍼에서 지우고
에러 화면을 출력할 수 있습니다.
마지막으로 버퍼가 다 차기 전에는 헤더 정보를 변경할 수 있습니다.


1) page 디렉티브에서 버퍼 설정하기 : buffer 속성과 autoFlush 속성
page 디렉터브는 buffer 속성을 제공하고 있습니다. 이 buffer 속성을 사용하면 JSP 페이지가
사용할 버퍼를 설정할 수 있습니다. buffer 속성은 JSP 페이지가 사용할 버퍼의 크기를
지정할 때 사용하며, 다음과 같이 킬로바이트 단위로 버퍼의 크기를 지정합니다.
<%@ page buffer = "4kb" %>
buffer 속성값에 kb를 붙이지 않으면 JSP 페이지를 자바 코드로 변환하는 과정에서
에러가 발생합니다. 즉, 버퍼는 킬로바이트 단위로 지정할 수 있습니다.
참고로, 보통 JSP 페이지를 작성할 때에는 buffer 속성을 지정하지 않습니다.
즉, 지금까지 코딩했던 예제들은 모두 buffer 속성을 사용하지 않았습니다.
JSP 규약은 butter 속성을 지정하지 않으면 최소한 8KB 이상의 크기를 갖는
버퍼를 사용하도록 규정하고 있습니다.
버퍼를 사용하고 싶지 않다면 buffer 속성의 값을 다음과 같이 "none”으로 지정하면 됩니다.
〈%@ page buffer = "none" %>

buffer 속성의 값을 "none"으로 지정하면 JSP 페이지가 출력하는 내용을 곧바로
웹 브라우저에 전송하기 때문에, 다음과 같은 기능을 사용하는 데 제한이 따른다.
1) <jsp：forward> 기능을 사용할 수 없습니다.
2) 곧바로 전송되기 때문에 출력한 내용을 취소할 수 없습니다.
위와 같은 제한이 있기 때문에, buffer 속성의 값을 "none"으로 지정하는 경우는
거의 없지만, 이런 설정도 있다는 정도는 알도록 합니다.

버퍼가 다차면 JSP 페이지는 버퍼의 내용을 웹 브라우저에 전송한 후
버퍼를 비우고 새롭게 버퍼에 내용을 채우기 시작합니다.

* 플러시(flush)
버퍼가 다 찼을 때, 버퍼에 쌓인 데이터를 실제로 전송되어야 할 곳（또는 저장되어야 할 곳）에
전송하고（또는 저장하고） 버퍼를 비우는 것을 플러시（flush）라고 합니다.

page 디렉터브는 autoFlush 속성을 제공합니다. 이 속성을 사용하면 버퍼가 다 찼을 때
어떻게 처리할지를 결정할 수 있습니다.
autoFlush 속성은 "true"나 "false"를 값으로 갖는데, 각 값에 따라서 다음과 같이 처리한다.
1) true : 버퍼가 다 차면 버퍼를 플러시하고 계속해서 작업을 진행합니다.
2) false : 버퍼가 다 차면 익셉션을 발생시키고 작업을 중지합니다.

* JSP 소스 코딩 실행 확인 : 앞서 autoFlush 속성의 true, false 두 값의 차이점을 비교하기 위해서
                                  버퍼의 크기를 1kb로 지정하고 각 JSP 코드는 1KB가 넘는 데이터를 생성하도록 해봅니다.
[source03 폴더 안에 autoFlushFalse.jsp 소스 코딩]
[source03 폴더 안에 autoFlushTrue.jsp 소스 코딩]
                                 
autoFlushFalse.jsp는 autoFlush 속성을 false로 지정했으며, 이 속성이 false이므로,
버퍼 크기보다 많은 데이터를 생성하는 autoFlushFalse.jsp를 실행하면 익셉션이 발생합니다.
에러 메시지를 보면 "root cause" 부분에 "JSP Buffer overflow" 라는 문장을 확인할 수 있습니다.

autoFlushTrue.jsp는 autoFlush 속성이 true이므로，JSP 페이지가 생성하는 데이터 크기가
버퍼 크기보다 커지면 자동으로 버퍼를 플러시(flush)하기 때문에 정상적으로 실행됩니다.

3. 웹 어플리케이션 플더 구성과 URL 매명
JSP를 이용해서 웹 어플리케이션을 개발하려면 기초 문법뿐만 아니라 웹 어플리케이션의
폴더 구조에 대해서도 알아야 합니다. 서블릿/JSP 규약은 웹 어플리케이션이 특정 폴더 구조를
따르도록 제한하고 있기 때문에, 이 폴더 구조를 모르면 제대로 동작하는 코드를 작성할 수 없게 됩니다.

* WEB-INF 폴더와 그 하위 폴더 의미는 다음과 같습니다.
[다음]
* WEB-INF : 웹 어풀리케이션 설정 정보를 담고 있는 web.xml 파일이 위치합니다.
* WEB-INF\classes : 웹 어플리케이션에서 사용하는 클래스 파일이 위치합니다.
* WEB-INF\lib : 웹 어플리케이션에서 사용하는 jar 파일이 위치합니다.
* WEB-INF 폴더와 그 하위 폴더를 제외한 나머지 폴더에는 웹 어플리케이션에서 사용할
  JSP, HTML, 이미지 등의 파일이 위치합니다.
* 서블릿 2.4/JSP 2.0 규약은 web.xml 파일을 반드시 포함하도록 제한하고 있었는데,
  서블릿 2.5/JSP 2.1 규약부터는 이 제한이 없어졌습니다.
  web.xml 파일을 포함하지 않아도 되도록 바뀐 것입니다. 예를 들어,
  서블릿 2.5/JSP 2.1 버전 또는 그 이후 버전을 사용한다면, 웹 어플리케이션이 JSP 코드로만
  구성될 경우 web.xml 파일을 작성하지 않아도 됩니다.
  그러나 다음 경우에는 web.xml 파일을 작성해야 한다.
  - 서블릿을 직접 설정하는 경우
  - 리스너(Listener)를 직접 설정하는 경우
  - 특정 URL에 속하는 JSP들에 대해 공통 속성값을 설정하는 경우

1) 웹 어플리케이션 폴더와 URL의 관계
   한 웹 어플리케이션은 한 개 폴더를 차지합니다.

• [톰켓]\webapps\[웹경로] → http://host:port[/웹경로]

톰켓의 webapps 폴더에는 ROOT라는 특수 폴더가 존재합니다.
이 폴더는 루트 웹 어플리케이션을 위한 특수 폴더입니다.

* JSP 소스 코딩 확인
[source03 폴더 안에 contextPath.jsp 소스 코딩 - 실행 확인]

2) 웹 어플리케이션 폴더 내에서의 하위 폴더 사용
웹 어플리케이션 폴더 밑에 하위 폴더를 생성해서 JSP페이지를 기능별로 분류해서 구성할 수도 있습니다.

4. 웹 어플리케이션 배포
웹 어플리케이션을 WAS에 배포하는 방법은 다음의 두 가지가 있습니다.
1) 첫번째 방법 = 대상 폴더에 파일을 직접 복사 : 지금까지 JSP 웹페이지를 직접 소스 코딩 실행 했던 방식
2) 두번째 방법 = 톰캣에 war 파일로 묶어서 배포
   웹 어플리케이션을 배포하는 두 번째 방법은 웹 어플리케이션을 war 파일로 묶어서 배포하는 것입니다.
   war는 Web Application Archive의 약자로 웹 어플리케이 션의 구성 요소를 하나로 묶어 놓은 파일입니다.
   war 파일로 묶으려면 JDK의 jar 명령어를 사용하면 됩니다. jar 명령어는 javac 명령어와 동일하게
   [JDK설치폴더]\bin 폴더에 포함되어 있습니다. PATH 환경 변수에 [JDK설치폴더]\bin 폴더를 추가해주면
   전체 경로를 입력할 필요 없이 jar 명령어를 실행할 수 있습니다.

   cvf 옵션을 사용해서 jar 명령어를 실행하면 war 파일을 생성할 수 있습니다.
   다음은 jar 명령의 사용 예시입니다.
   C:\apache-tomcat_9.0\webapps\source03〉jar cvf source03.war *
   Manifest를 추가함
   추가하는 중: autoFlushFalse.jsp（입 력 = 248） （출력 = 198）（20%를 감소함）
   추가하는 중: autoFlushTrue.jsp（입력 - 246） （출력 : 192）（21%를 감소함）
   추가하는 증: contextPath.jsp（입력 = 231） （출력 = 191）（17%를 감소함）

   * cvf에서 각 옵션은 다음을 뜻한다.
   [다음]
   ① C : 새로운 파일을 생성함
   ② V : 세부 정보를 콘솔（명령 프롬프트）에 표시함
   ③ f : 생성할 파일의 이름을 지정함

옵션 뒤에 위치한 "source03.war"는 생성할 파일 이름입니다.
파일 확장자로 "war”를 사용해서 war 파일임을 알 수 있도록 했습니다.
마지막의 "*"은 현재 폴더의 모든 파일과 하위 폴더가 대상임을 의미합니다.
즉, source03 폴더에 포함된 모든 파일과 폴더를 묶어서 source03.war 파일을 만듭니다.

jar 명령어를 실행하면 source03.war 파일이 생성됩니다. 이 파일을 실제 서버의
[톰켓]\webapps 폴더에 복사해주면 배포가 됩니다.

* source03.war 파일 생성 및 웹 실행 확인 예시
1단계) C:\apache-tomcat_9.0\webapps\source03〉jar cvf source03.war *
2단계) [톰캣] - webapps 폴더에 복사된 source03.war 파일 붙여넣기 함.
3단계) 톰캣 구동하고 새로고침하면 1초 ~ 3초 정도 잠시 뒤에
         source03 폴더가 생성됨.webapps 폴더에 source03 폴더가 생성됨.
4단계) 생성된 source03 폴더 안에 배포된 파일들과 META-INF 폴더 확인함.
5단계) 웹 브라우저 실행 후 URL을 http://localhost:8080/autoFlushTrue.jsp 입력해서
         배포된 jsp 웹 소스 실행 확인함.
참고로, source03.war 파일을 삭제하면, source03 폴더도 사라짐.



