# 쿠키 이해

[쿠키를 이용한 로그인처리]
웹 서버는 쿠키를 이용해서 웹 브라우저에 정보를 전송할 수 있습니다.
웹 서버로부터 쿠키를 전달받은 웹 브라우저는 이후 웹 서버에 요청을 보낼 때
쿠키를 함께 전송합니다. 이를 사용하면 웹 서버와 웹 브라우저는 필요한 값을
공유하고 상태를 유지할 수 있습니다.

1. 쿠키 사용하기
쿠키(cookie)는 웹 브라우저가 보관하는 데이터입니다.
웹 브라우저는 웹 서버에 요청을 보낼 때 쿠키를 함께 전송하며,
웹 서버는 웹 브라우저가 전송한 쿠키를 사용해서 필요한
데이터를 읽을 수 있습니다. 쿠키는 웹 서버와 웹 브라우저 양쪽에서 생성할 수 있는데,
JSP에서 생성하는 쿠키는 웹 서버에서 생성하는 쿠키입니다.

["그림_1) 쿠키 동작 방식" 참고]

쿠키 동작 방식은 "그림_1) 쿠키 동작 방식"과 같이 3단계로 구성됩니다.
① 쿠키 생성 단계 : 쿠키를 사용하려면 먼저 무키를 생성해야 합니다.
    JSP 프로그래밍에서 쿠키는 웹 서버 측에서 생성합니다.
   생성한 쿠키를 응답 데이터의 헤더에 저장해서 웹 브라우저에 전송합니다.
② 쿠키 저장 단계 : 웹 브라우저는 응답 데이터에 포함된 무키를 쿠키 저장소에 보관합니다.
                        쿠키의 종류에 따라 메모리나 파일에 저장합니다.
③ 쿠키 전송 단계 : 웹 브라우저는 저장한 쿠키를 요청이 있을 때마다 웹 서버에 전송합니다.

웹 서버는 웹 브라우저가 전송한 쿠키를 사용해서 필요한 작업을 수행합니다.
일단 웹 브라우저에 쿠키가 저장되면，웹 브라우저는 쿠키가 삭제되기 전까지
웹 서버에 쿠키를 전송합니다. 따라서 웹 어플리케이션을 사용하는 동안
지속적으로 유지해야 하는 정보는 쿠키를 사용해서 저장하면 됩니다.

1) 쿠키의 구성
쿠키를 구성하는 요소는 다음과 같습니다.
- 이름 : 각각의 쿠키를 구별하는 데 사용되는 이름
- 값 : 쿠키의 이름과 관련된 값
- 유효시간 : 쿠키의 유지 시간
- 도메인 : 쿠키를 전송할 도메인
- 경로 : 쿠키를 전송할 요청 경로

쿠키의 핵심 요소는 이름과 값입니다. 하나의 웹 브라우저는
여러 개의 쿠키를 가질 수 있는데,
각 쿠키를 구분할 때 이름을 사용합니다.
각 쿠키는 값을 가지며 서버는 이 값을 사용해서 원하는 작업을 수행하게 됩니다.
쿠키 이름은 콤마, 세미콜론, 공백, 등호기호('=’)를 제외한
출력 가능한 아스키 문자로 구성됩니다. 여러 문자를 사용할 수 있지만
보통 쿠키 이름을 작성할 때에는 알파벳과 숫자만 이용합니다.
쿠키 값은 콤마, 세미콜론，공백 문자를 제외한 나머지 출력 가능한
아스키 문자를 사용할 수 있습니다. 값으로 사용할 수 있는 문자가
한정되어 있기 때문에 쿠키 값을 생성할 때에는 알맞은 방식으로 인코딩합니다.
예를 들어, 자바에서는 URL 인코딩을 사용해서 쿠키 값으로 사용할 문자열을
변환할 수도 있습니다.
하지만, 실제로 쿠키 이름과 값은 더 많은 제약을 갖고 있습니다.
예를 들어, RFC2965 규약에 따르면 쿠키 값은 '(' 또는 ')' 등의 문자를 포함할 수 없습니다.

유효시간을 사용하면 웹 브라우저가 쿠키를 얼마 동안 보관할지를 지정할 수 있스니다.
예를들어, 쿠키 유효 시간을 1시간으로 지정하면 1시간 뒤에 웹 브라우저는 해당 쿠키를
삭제하며, 별도 유효 시간을 지정하지 않으면 웹 브라우저를 종료할 때 쿠키를 함께 삭제 합니다.
또한，지정한 도메인이나 경로로만 쿠키를 전송하도록 제한할 수도 있습니다.


2) 쿠키생성하기
JSP에서 쿠키를 생성할 때에는 Cookie 클래스를 사용합니다.
Cookie 클래스를 사용해서 쿠키를 추가하는 코드는 다음과 같습니다.
<%
   Cookie cookie = new Cookie("cookieName"，"cookieValue");
   response.addCookie(cookie);
%>
위 코드에서 첫 번째 줄은 쿠키 정보를 담고 있는 Cookie 객체를 생성합니다.
Cookie 클래스 생성자의 첫 번째 인자는 쿠키의 이름을, 두 번째 인자는 쿠키의 값을 지정합니다.
생성할 쿠키 정보를 담고 있는 Cookie 객체를 생성했다면, response 기본 객체의
addCookie() 메서드를 사용하여 쿠키를 추가하면 됩니다. response.addCookie() 메서드를
사용하면 response 기본 객체는 웹 브라우저에 쿠키 정보를 전송합니다.

* JSP 소스 코딩 : 쿠키를 생성하는 예시
[source08 폴더 안에 makeCookie.jsp 소스 코딩]

Cookie 객체를 생성한 후에는 다음과 같은 메서드를 사용하여
쿠키의 특징을 변경하거나 읽어올 수 있습니다.
[다음 : Cookie 클래스가 제공하는 메서드]
  메서드			리턴 타입		의미
getName()		String		쿠키 이름을 구합니다.
getValue()		String		쿠키 값을 구합니다.
setValue(String value)	void		쿠키 값을 지정합니다.
setDomain(String pattern)	void		이 쿠키가 전송될 서버의 도메인을 지정합니다.
getDomain()		String		쿠키의 도메인을 구합니다.
setPath(String uri)		void		쿠키를 전송할 경로를 지정합니다.
getPath()			String		쿠키의 전송 경로를 구합니다.
setMaxAge(int expiry)	void		쿠키의 유효시간을 초 단위로 지정합니다.
                                                            음수를 입력할 경우 웹 브라우저를 닫을 때
					쿠키가 함께 삭제됩니다.
getMaxAge()		int		쿠키의 유효시간을 구합니다.

쿠키의 도메인과 경로는 도메인 간에 또는 특정 요청 경로에 위치한
JSP 간에 쿠키를 공유할 때 필요합니다.

3) 쿠키 값 읽어오기
쿠키를 생성하면, 그 이후부터 해당 쿠키를 사용할 수 있습니다.
웹 브라우저는 요청 헤더에 쿠키를 저장해서 보내며,
JSP는 다음 코드를 사용해서 쿠키 값을 읽어올 수 있습니다.
[다음]
Cookie[] cookies = request. getCookies();
request. getCookies() 메서드는 Cookie 배열을 리턴합니다.
이 메서드는 읽어올 쿠키가 존재하지 않으면 null을 리턴합니다.

* JSP 소스 코딩 : request.getCookies() 메서드를 사용하여
                     웹 브라우저가 전송한 쿠키 목록을 출력해주는 예시 JSP 소스 코딩
[source08 폴더 안에 viewCookies.jsp 소스 코딩]

4) 쿠키 값 변경 및 쿠키 삭제하기
쿠키 값을 변경하려면 같은 이름의 쿠키를 새로 생성해서 응답 데이터로 보내면 됩니다.
예를 들어, 이름이 "name"인 쿠키의 값을 변경하기 위해서는 다음과 같이 새로운
Cookie 객체를 생성해서 응답 데이터에 추가하면 됩니다.
[다음]
Cookie cookie = new Cookie("name", URLEncoder.encode("새로운값", "euc-kr"));
response. addCookie(cookie);

쿠키의 값을 변경한다는 것은 기존에 존재하는 쿠키의 값을 변경한다는 것입니다.
위 코드를 실행하면 쿠키가 존재하지 않으면 쿠키가 생성되므로,
쿠키 값을 변경하려면 쿠키가 존재하는지 먼저 확인해야 합니다.

* JSP 소스 코딩 : makeCookie.jsp에서 생성한 name 쿠키의 값을 변경해주는
                      JSP 소스 코딩
[source08 폴더 안에 modifyCookie.jsp 소스 코딩]

쿠키를 삭제하려면 다음과 같이 Cookie 클래스의 setMaxAge() 메서드를 호출할 때
인자 값으로 0을 주면 됩니다.
[다음]
Cookie cookie = new Cookie(name, value);
cookie.setMaxAge(0);
response.addCookie(cookie);

Cookie 클래스는 쿠키를 삭제하는 기능을 별도로 제공하지 않습니다.
위 코드처럼 유효시간을 0으로 지정해준 후 응답 헤더에 추가하면,
웹 브라우저가 관련 쿠키를 삭제하게 됩니다.

* JSP 소스 코딩 : 앞서 생성한 name 쿠키를 삭제하는 JSP 소스 코딩
[source08 폴더 안에 deleteCookie.jsp 소스 코딩]

deleteCookie.jsp를 실행한 후 viewCookies.jsp를 실행하면,
name 쿠키가 삭제된 것을 확인할 수 있을 것입니다.

5) 쿠키의 유효시간
쿠키는 유효시간을 갖습니다. 쿠키의 유효시간을 지정하지 않으면 웹 브라우저를 종료할 때
쿠키를 함께 삭제합니다. 웹 브라우저 종료 후 다시 웹 브라우저를 실행하면 삭제한 쿠키는
서버에 전송되지 않습니다. 쿠키의 유효시간을 정해 놓으면 그 유효시간 동안 쿠키가 존재하며,
웹 브라우저를 종료해도 유효시간이 지나지 않았으면 쿠키를 삭제하지 않습니다.
유효 시간을 지정하려면 setMaxAge() 메서드를 사용합니다. setMaxAge()는 초 단위로
유효 시간을 지정합니다.

* JSP 소스 코딩 : 쿠키의 유효시간을 1시간으로 지정하는 JSP 소스 코딩
[source08 폴더 안에 makeCookieWithMaxAge.jsp 소스 코딩]

makeCookieWithMaxAge.jsp를 실행한 후, 웹 브라우저를 종료합니다.
브라우저 창을 여러 개 실행하고 있다면, 모두 종료해야 합니다.
종료한 뒤 1시간 이내에 웹 브라우저를 실행하고,
viewCookies.jsp를 실행해서 쿠키 목록을 살펴봅니다.
그러면, 쿠키가 삭제되지 않고 웹 서버에 전송되는 것을 확인할 수 있습니다.

* 아이디 기억하기 기능의 구현 방법
아이디 기억하기 기능을 구현할 때 쿠키를 사용합니다.
사용자가 로그인에 성공하면 아이디를 값으로 저장하고 있는
쿠키의 유효시간을 1개월 정도로 여유롭게 잡아서 생성합니다.
그러면 웹 브라우저를 닫더라도 유효시간이 충분히 남아 있기 때문에
다음에 웹 브라우저를 실행할 때 아이디를 저장하고 있는 쿠키를 사용할 수 있습니다.
따라서 웹 프로그램은 아이디 쿠키가 존재하면 쿠키 값을 로그인 폼에
출력해서 아이디 기억하기 기능을 구현할 수 있습니다.
비슷한 방식으로 로그인 정보를 쿠키에 보관하면 자동 로그인 기능을 구현할 수도 있습니다.


2. 쿠키 저리를 위한 유틸리티 클래스
특정 쿠키의 값을 읽으려면 다음과 같은 형태의 코드를 사용해야 합니다.
[다음]
Cookie[] cookies = request.getCookies():
Cookie nameCookie = null；
Cookie idCookie = null；
if (cookies != null) {
  for (int i = 0; i < cookies.length; i++) {
     if(cookies[i].getName().equals("name")) {
     nameCookie = cookies[i];
     } else if (cookies[i].getName().equals("id")) {
         idCookie = cookies[i];
     }
  }
}
String name = URLDecoder.decode(nameCookie.getValue(), "utf-8");
위 코드는 Cookie 목록을 가져와 if-else 블록에서 쿠키 이름을 비교해서 필요한 쿠키를
구하고 있습니다. 이런 구조는 사용할 쿠키가 많아질수록 if-else 코드가 복잡해지는
문제가 있습니다. 그래서 더욱 편리하게 쿠키를 사용할 수 있도록 도와주는
보조 유틸리티 클래스를 활용합니다.

* JAVA 소스 코드 : source08 폴더 안에 WEB-INF 폴더 안에
                        src 폴더 안에 util 폴더 안에 Cookie.java 소스 코딩

1) Cookies 클래스를 이용한 쿠키 생성
Cookies 클래스로 쿠키를 생성하는 방법을 살펴봅니다.
쿠키를 생성할 때에는 Cookies.createCookie() 메서드를 사용합니다.
Cookies 클래스는 세 가지 createCookie() 메서드를 제공하며,
다음과 같이 사용할 수 있습니다.
[다음]
Cookie cookiel = Cookies.createCookie("name", "장나라");
Cookie cookie2 = Cookies.createCookie("name2", "장나라", "/path1", -1);
Cookie cookie3 = Cookies.createCookie("id", "jsp", ".kbs.co.kr", "/", 60);

Cookie 클래스를 직접 사용하면 다음과 같이 도메인, 경로, 유효시간을 설정할 때
입력할 코드가 많아지는데，Cookies 클래스를 사용하면 코드가 간결해지는 것을 알 수 있습니다.
[다음]
Cookie cookie = new Cookie("id", URLEncoder.encode(value, "utf-8"));
cookie.setDomain(".kbs.co.kr");
cookie.setPath("/");
cookie.setMaxAge(60);

* JSP 소스 코딩 : Cookies.createCookie() 메서드를 사용해서 쿠키를 생성하는 JSP 소스 코딩
[source08 폴더 안에 makeCookieUsingCookies.jsp]

2) 쿠키를 사용한 로그인 상태 유지
웹 사이트의 기본 기능 중 하나는 로그인/로그아웃 기능입니다.
웹 브라우저에서 페이스북이나 메일 서비스를 사용할 때 가장 먼저 하는 것이 로그인입니다.
로그인하지 않은 상태에서 접근하면 로그인하도록 유도하는데,
이는 로그인했는지 여부를 확인할 수 있는 방법이 필요하다는 것을 뜻합니다.
로그인 상태를 확인할 때 가장 많이 사용하는 방법이 바로 쿠키를 이용하는 것입니다.

* 쿠키를 이용하면 다음과 같은 방법으로 로그인 상태를 유지할 수 있습니다.
[다음]
① 로그인에 성공하면 특정 이름을 갖는 무키를 생성합니다.
② 해당 쿠키가 존재하면 로그인한 상태라고 판단합니다.
③ 로그아웃하면 해당 쿠키를 삭제합니다.

예를 들어, 로그인에 성공하면 "AUTH”라는 쿠키를 생성하고, "AUTH" 쿠키가 존재하면
로그인한 상태라고 인식하는 것입니다.

3) 로그인 처리
쿠키를 이용해서 로그인 상태를 확인하는 코드를 만들기 전에
간단한 로그인 폼을 보여주는 JSP 코드를 작성합니다.

* JSP 소스 코딩 : 간단한 로그인 폼을 생성해주는 JSP 소스 코딩
[source08 폴더 안에 member 폴더 안에 loginForm.jsp 소스 코딩]

loginForm.jsp 실행 후 [로그인] 버튼을 누르면 login.jsp로 입력한 데이터를 전송합니다.

* JSP 소스 코딩 : 아이디와 암호가 같으면 로그인에 성공한다는 가정하에 login.jsp 소스 코딩
[source08 폴더 안에 member 폴더 안에 login.jsp 소스 코딩]

login.jsp는 로그인에 성공했을 경우, 로그인과 관련된 AUTH 쿠키를 추가합니다.

4) 로그인 여부 판단
로그인에 성공했음을 나타내는 쿠키를 생성한 이후, 웹 브라우저는 요청을 보낼 때마다
쿠키를 전송합니다. 그러므로 로그인에 성공할 때 생성되는 쿠키가 존재하는지 확인하면
현재 로그인했는지 여부를 판단할 수 있습니다.
따라서 로그인 여부를 판단하는 코드는 다음과 같은 형태를 띠게 됩니다.
[다음]
Cookies cookies = new Cookies(request);
String id = cookies.getValue("AUTH"));
if (id != null) {
   // 로그인 한 경우의 처리
   ...
} else {
   // 로그인 하지 않은 경우의 처리
   ...
}

* JSP 소스 코딩 : login.jsp에서 생성한 AUTH 쿠키를 사용해서 로그인 여부를 판단하는 JSP 페이지 소스 코딩
[source08 폴더 안에 member 폴더 안에 loginCheck.jsp 소스 코딩]

loginCheck.jsp는 AUTH 쿠키가 존재하면 로그인을 했다고 판단합니다.
로그인하지 않은 상태, 즉 AUTH 쿠키가 없는 상태에서 loginCheck.jsp를 실행하면
"로그인하지 않은 상태"가 화면으로 출력됩니다.

5) 로그아웃 처리
로그인에 성공하면 쿠키를 생성하므로, 로그아웃을 처리하려면 쿠키를 삭제하면 됩니다.

* JSP 소스 코딩 : 앞서 "AUTH" 쿠키를 사용했으므로,
                      AUTH 쿠키의 유효시간을 0으로 지정하는 JSP 소스 코딩
[source08 폴더 안에 member 폴더 안에 logout.jsp 소스 코딩]

로그인한 상태라면 logout.jsp를 실행한 후 loginCheck.jsp를 실행해 봅니다.
logout.jsp를 실행하면 AUTH 쿠키를 삭제하므로, "로그인하지 않은 상태"가 화면으로 출력됩니다.

